trigger:
- main

pr:
- "*"

variables:
  - group: azure_env

jobs:
- job: buildAndDeploy
  displayName: 'Build & Deploy'
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - checkout: self

  - script: |
      export AZURE_APP_NAME=$(appServiceName)
      export AZURE_RESOURCE_GROUP=$(resourceGroup)
      export AZURE_SUBSCRIPTION_ID=$(subscriptionId)
      export AZURE_CREDENTIALS=$(azureServicePrincipal)
      export AZURE_TENANT_ID=$(tenantId)
    displayName: 'Set Environment Variables'

  - task: UseDotNet@2
    inputs:
      packageType: 'sdk'
      version: '7.x' 
      installationPath: $(Agent.ToolsDirectory)/dotnet

  - script: |
      dotnet build --configuration Release
    displayName: 'Build .NET Project'

  - script: |
      docker-compose -f docker-compose.yml build
    displayName: 'Build Docker Image using Docker Compose'

  - script: |
      echo $(AZURE_CREDENTIALS) | az login --service-principal --username $(servicePrincipalId) --password $(servicePrincipalKey) --tenant $(tenantId)

      az webapp config container set --name $(AZURE_APP_NAME) --resource-group $(AZURE_RESOURCE_GROUP) --docker-custom-image-name $(AZURE_APP_NAME):latest
    displayName: 'Deploy to Azure App Service'
